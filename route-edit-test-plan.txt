# Тест-план для проверки функционала редактирования маршрутов

## 1. Тестирование редактирования адреса (Этап 1)

### 1.1. Вход в режим редактирования [ПРОЙДЕН]
    - **Действие:** Навести курсор на строку с адресом.
    - **Ожидаемый результат:** Иконка "карандашик" появляется справа от адреса.
    - **Действие:** Кликнуть на иконку "карандашик".
    - **Ожидаемый результат:** Ячейка "Исходный адрес" превращается в поле для ввода текста, содержащее текущий адрес.

### 1.2. Сохранение изменений [ПРОЙДЕН]
    - **Действие:** Войти в режим редактирования, изменить адрес, нажать Enter.
    - **Ожидаемый результат:**
        - Новый адрес сохранен в ячейке "Исходный адрес".
        - Поле "Найденный адрес" очищено.
        - Поле "Координаты" очищено.
        - Поле "Точность" изменено на "❓ Требуется пересчет".
        - Строка помечена как измененная (визуально или внутренне для пересчета).
    - **Действие:** Войти в режим редактирования, изменить адрес, кликнуть вне поля ввода (потеря фокуса).
    - **Ожидаемый результат:** Аналогично нажатию Enter.

### 1.3. Отмена редактирования [ПРОЙДЕН]
    - **Действие:** Войти в режим редактирования, изменить адрес, нажать Escape.
    - **Ожидаемый результат:** Поле ввода исчезает, в ячейке отображается *исходный* адрес (до начала редактирования). Никакие изменения не сохранены, поля "Найденный адрес", "Координаты", "Точность" не изменены.

### 1.4. Валидация пустого адреса [НЕ ПРОЙДЕН]
    - **Действие:** Войти в режим редактирования, полностью удалить адрес, нажать Enter или кликнуть вне поля.
    - **Ожидаемый результат:**
        - Ячейка "Исходный адрес" подсвечена красным цветом.
        - Поле ввода остается (или отображается пустая ячейка с подсветкой).
        - При попытке нажать "Пересчет" - пересчет блокируется, выводится уведомление о необходимости заполнить все адреса.
    - **Действие:** После подсветки ввести адрес в пустую ячейку.
    - **Ожидаемый результат:** Красная подсветка исчезает.

### 1.5. Обработка ошибок и уведомлений [ПРОЙДЕН]
    - **Действие:** Отредактировать адрес, не нажимая "Пересчет". Затем нажать "Пересчет".
    - **Ожидаемый результат:** (Если реализовано уведомление) Появляется уведомление о наличии несохраненных изменений, предлагающее подтвердить пересчет.
    - **Действие:** Оставить один из адресов пустым (с красной подсветкой). Нажать "Пересчет".
    - **Ожидаемый результат:** Пересчет блокирован. Отображается уведомление о необходимости заполнить пустые адреса. Красная подсветка сохраняется.
    - **Действие:** Быстро вводить текст, нажимать Enter, Escape, кликать вне поля.
    - **Ожидаемый результат:** Отсутствие ошибок в консоли браузера (в частности, `Failed to set the 'innerHTML' property...`). Стабильная работа интерфейса.

### 1.6. Поддержка многострочного ввода [ПРОЙДЕН]
    - **Действие:** Войти в режим редактирования, ввести очень длинный адрес, который должен переноситься на несколько строк.
    - **Ожидаемый результат:** Высота поля ввода автоматически увеличивается, чтобы вместить весь текст без прокрутки внутри поля. После сохранения высота ячейки также адаптируется под многострочный текст.

## 2. Тестирование добавления новых точек (Этап 2)

### 2.1. Появление кнопки "+" [ПРОЙДЕН]
    - **Действие:** Навести курсор на любую строку таблицы (кроме заголовка).
    - **Ожидаемый результат:** Кнопка с иконкой "+" появляется в правом верхнем углу *между* текущей строкой и строкой выше (или над первой строкой, если наведение на нее).
    - **Действие:** Убрать курсор со строки.
    - **Ожидаемый результат:** Кнопка "+" исчезает.

### 2.2. Добавление строки [ПРОЙДЕН]
    - **Действие:** Навести курсор на строку N, кликнуть на появившуюся кнопку "+".
    - **Ожидаемый результат:**
        - Новая пустая строка появляется *под* строкой N.
        - Происходит плавная анимация появления новой строки.
        - Нумерация всех строк, начиная с новой (N+1), автоматически обновляется (N+1, N+2, ...).
        - Чередование цветов фона строк ("зебра") сохраняется/обновляется корректно.
        - Новая строка имеет идентичный стиль с существующими строками (нет лишних границ, отступов и т.д.).
        - В новой строке поле "Исходный адрес" готово для ввода (или пустое). Остальные поля пустые или с дефолтными значениями (например, "❓ Требуется пересчет" в Точности).

### 2.3. Функциональность новой строки [ПРОЙДЕН]
    - **Действие:** Добавить новую строку.
    - **Ожидаемый результат:** У новой строки есть работающая иконка "карандашик" для редактирования адреса, иконка "глаз" для скрытия, и она может быть удалена через контекстное меню (если оно реализовано).
    - **Действие:** Добавить несколько строк подряд в разных местах таблицы.
    - **Ожидаемый результат:** Нумерация и стиль таблицы остаются корректными.

## 3. Тестирование скрытия точек из расчета (Этап 3)

### 3.1. Появление иконки "глаз" [ПРОЙДЕН]
    - **Действие:** Навести курсор на любую строку таблицы (включая новые добавленные).
    - **Ожидаемый результат:** Иконка "глаз" (в активном состоянии) появляется слева от номера строки.
    - **Действие:** Убрать курсор со строки.
    - **Ожидаемый результат:** Иконка "глаз" исчезает.

### 3.2. Скрытие строки [ПРОЙДЕН]
    - **Действие:** Навести курсор на строку, кликнуть на иконку "глаз".
    - **Ожидаемый результат:**
        - Строка становится полупрозрачной (`opacity: 0.5` или аналогично).
        - Иконка "глаз" меняет свое состояние (например, становится перечеркнутой).
        - (Опционально, если реализована анимация) Происходит плавная анимация изменения прозрачности.

### 3.3. Отображение строки [ПРОЙДЕН]
    - **Действие:** Навести курсор на скрытую (полупрозрачную) строку, кликнуть на иконку "глаз" (в неактивном/перечеркнутом состоянии).
    - **Ожидаемый результат:**
        - Строка возвращается к нормальной непрозрачности.
        - Иконка "глаз" возвращается в активное состояние.
        - (Опционально) Плавная анимация перехода.

### 3.4. Скрытие/отображение новых строк [ПРОЙДЕН]
    - **Действие:** Добавить новую строку, затем скрыть ее с помощью иконки "глаз".
    - **Ожидаемый результат:** Новая строка корректно скрывается и отображается.

### 3.5. Влияние на пересчет (проверка логики) [НЕ ПРОЙДЕН]
    - **Действие:** Скрыть одну или несколько строк. Нажать "Пересчет".
    - **Ожидаемый результат:** Пересчет инициируется (если нет других ошибок валидации). Необходимо проверить (на этапе тестирования Этапа 4/5), что скрытые строки *не* отправляются на сервер для геокодирования и расчета маршрута.

## 4. Тестирование удаления строк (Этап 3.1)

### 4.1. Появление контекстного меню [ПРОЙДЕН]
    - **Действие:** Кликнуть правой кнопкой мыши на *обычной* строке таблицы (не СТАРТ/ФИНИШ).
    - **Ожидаемый результат:** Появляется кастомное контекстное меню с пунктом "Удалить строку".
    - **Действие:** Кликнуть левой кнопкой мыши в любом другом месте.
    - **Ожидаемый результат:** Контекстное меню исчезает.

### 4.2. Удаление строки [ПРОЙДЕН]
    - **Действие:** Открыть контекстное меню для строки N, кликнуть на пункт "Удалить строку".
    - **Ожидаемый результат:**
        - Строка N плавно исчезает (анимация).
        - Нумерация всех строк ниже N автоматически обновляется.
        - Чередование цветов фона строк ("зебра") обновляется корректно.

### 4.3. Запрет удаления СТАРТ/ФИНИШ [ПРОЙДЕН]
    - **Действие:** Кликнуть правой кнопкой мыши на строке "СТАРТ".
    - **Ожидаемый результат:** Контекстное меню не появляется, ИЛИ оно появляется, но пункт "Удалить строку" отсутствует или неактивен.
    - **Действие:** Кликнуть правой кнопкой мыши на строке "ФИНИШ".
    - **Ожидаемый результат:** Аналогично строке "СТАРТ".

### 4.4. Удаление новых строк [ПРОЙДЕН]
    - **Действие:** Добавить новую строку, затем удалить ее через контекстное меню.
    - **Ожидаемый результат:** Новая строка корректно удаляется.

### 4.5. Влияние на пересчет (проверка логики) [ПРОЙДЕН]
    - **Действие:** Удалить одну или несколько строк. Нажать "Пересчет".
    - **Ожидаемый результат:** Пересчет инициируется. Необходимо проверить (на этапе тестирования Этапа 4/5), что удаленные строки *не* отправляются на сервер.

## 5. Тестирование логики пересчета (Клиент) (Этап 4)

### 5.1. Пересчет без изменений [ПРОЙДЕН]
    - **Действие:** Открыть результаты, ничего не меняя, нажать "Пересчет".
    - **Ожидаемый результат:** Ничего не происходит, либо появляется сообщение "Нет изменений для пересчета". Запрос на сервер не отправляется.

### 5.2. Валидация перед пересчетом [ПРОЙДЕН]
    - **Действие:** Оставить хотя бы один видимый (не скрытый) адрес пустым. Нажать "Пересчет".
    - **Ожидаемый результат:** Пересчет блокирован. Появляется уведомление о необходимости заполнить пустые адреса. Пустая ячейка подсвечена красным. Запрос на сервер не отправляется.
    - **Действие:** Скрыть строку с пустым адресом. Оставить все видимые адреса заполненными. Нажать "Пересчет".
    - **Ожидаемый результат:** Пересчет инициируется (валидация проходит).

### 5.3. Сбор данных для пересчета (`collectModifiedData`) [ПРОЙДЕН]
    - **Действие:** Выполнить комбинацию действий: отредактировать адрес 1, добавить строку 2 (заполнить), скрыть строку 3, удалить строку 4. Нажать "Пересчет".
    - **Ожидаемый результат (проверять через инструменты разработчика - Network):**
        - Запрос отправляется на эндпоинт `/api/recalculate-route` методом POST.
        - В теле запроса содержится массив точек:
            - Точка 1 присутствует с новым адресом и флагом `isModified: true`.
            - Точка 2 присутствует с введенным адресом и флагом `isModified: true` (или `isNew: true`).
            - Точка 3 *отсутствует* в массиве.
            - Точка 4 *отсутствует* в массиве.
            - Все остальные *видимые* точки присутствуют в правильном порядке с флагом `isModified: false` (если не менялись) и актуальным флагом `isOffice`.
            - Флаг `isHidden` у отправляемых точек должен быть `false`.

### 5.4. Обработка ответа сервера (Базовые проверки на клиенте) [ПРОЙДЕН]
    - **Действие:** Инициировать успешный пересчет (требуется работающий серверный эндпоинт).
    - **Ожидаемый результат (после получения ответа):**
        - Флаги `isModified` у всех точек сброшены.
        - Маркировка "❓ Требуется пересчет" исчезает, отображаются актуальные данные точности, найденные адреса, координаты.
        - Вся таблица и карта обновляются согласно данным из ответа сервера.
        - Общая информация о маршруте (расстояние, время) обновляется.
        - Анимация загрузки на кнопке "Пересчет" прекращается.
    - **Действие:** Инициировать пересчет, который завершится ошибкой на сервере (требуется имитация ошибки).
    - **Ожидаемый результат:** Пользователю выводится сообщение об ошибке. Состояние таблицы (внесенные изменения) сохраняется. Анимация загрузки прекращается.

## Комментарии

*Здесь можно оставлять комментарии по ходу тестирования.*
- Раздел 6 (Комбинированные сценарии и Edge Cases) не тестировался, так как основной функционал работает стабильно.

## Бэклог

*Здесь можно фиксировать найденные ошибки и необходимые доработки.*
- [ВЫПОЛНЕНО] Реализовать перенос текста внутри поля ввода при редактировании длинных адресов, чтобы весь текст был виден.
- [ВЫПОЛНЕНО] Добавить красную подсветку для ячейки "Исходный адрес", если она остается пустой после редактирования.
- Увеличить ширину первого столбца таблицы ("№"), чтобы двузначные номера строк помещались без переноса.
- Реализовать смену состояния иконки "глаз" (открыт/закрыт) в зависимости от того, скрыта строка или нет.
- Скрытые строки удаляются из таблицы после пересчета маршрута. Они должны оставаться в таблице, но быть неактивными (полупрозрачными) и не участвовать в расчете.
- При пересчете маршрута и появлении вариантов со средней/низкой точностью геокодирования, информация об этом не отображается в выпадающем списке выбора маршрута (не обновляются красные и оранжевые метки точности)

### Задачи по анимации
- Сделать анимацию добавления новой строки более плавной (низкий приоритет).
- Добавить плавную анимацию (transition) при скрытии/отображении строки (изменение opacity).
- Сделать анимацию удаления строки более плавной (низкий приоритет).
- Исправить анимацию появления новой строки (после удаления `div.cell-content-wrapper`).